---
title: "Accelerated Breeding Initiative Dashboard"
author: ""
date: "2023-11-03"
output: html_document
params:
 toDownload: FALSE
---

```{r setup, include=FALSE}
# knitr R markdown chunk options
knitr::opts_chunk$set(dependson = knitr::all_labels(),
                      echo = FALSE,
                      cache = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      comment = NA,
                      out.width = "100%",
                      error = TRUE)
options(knitr.kable.NA = '')
# loading necessary R packages ####
## data manipulation
# library(dplyr)    # %>%, data cleaning functions
library(magrittr) # coerce col to factors or numeric
## outputs - graphs, tables
library(ggplot2)  # ggplot(), etc.
library(plotly)  # ggplot(), etc.
library(DT)       # datatable()
library(knitr)    # kable
library(data.table)
library(shiny)
```

```{r printfxn, include=FALSE}

# functions ####
# for printing tables (data.frames) - DT::datatable()
printTable <- function(DT, pageLength = 7, 
                       numericColNames = NULL, numRound = 3, ...) {
  
  DT <- data.frame(lapply(X = DT, 
                          FUN = function(x) {
                            if(is.numeric(x)){
                              round(x, numRound)
                            } else {
                              x
                            }
                          }))
  
  table <- DT::datatable(data = DT, 
                         filter = "top", 
                         options = list(autoWidth = TRUE, 
                                        dom = 'l<<t>pB>', 
                                        buttons = c('copy', 'excel'),
                                        pageLength = pageLength,
                                        searchHighlight = TRUE,
                                        lengthMenu = c(7, 14, 21, 28, 35)),
                         extensions = 'Buttons',
                         rownames = FALSE,
                         ...)
  if (length(numericColNames) > 0){
    table <- table %>% formatRound(columns = numericColNames,
                                   digits = numRound)
  }
  
  table
}
```

```{r, include=FALSE}
# Init Step to make sure that the dependencies are loaded
htmltools::tagList(printTable(mtcars))
htmltools::tagList(ggplotly(ggplot()))
# Get the current figure size in pixels:
get_w <- function() {
  with(knitr::opts_current$get(c("fig.width", "dpi", "fig.retina")),
       fig.width*dpi/fig.retina)
}

get_h <- function() {
  with(knitr::opts_current$get(c("fig.height", "dpi", "fig.retina")),
       fig.height*dpi/fig.retina)
}
```

### Data use

The following table shows which data was available and used for this pipeline. It allows to see whether the data has been QA and the summary values for the different data types.

<p>&nbsp;</p>

```{r, results='asis'}
suppressWarnings(tryCatch({
  if(file.exists("./outputs/resultAbi.RData")){
    load("./outputs/resultAbi.RData")
  }else{
    load("resultAbi.RData")
  }
}, error = function(e) {
  # NULL
}))

if (is.null(result)){
  # invisible(NULL)
} else {
  
  idAbi <- result$status[which(result$status$module == "abiDash"),"analysisId"];
  idAbi <- idAbi[length(idAbi)]
  modelingAbi <- result$modeling[result$modeling$analysisId == idAbi, ]
  
  idSta <- modelingAbi[modelingAbi$parameter == "forMetrics", "value"]
  
  pred <- result$predictions
  pred <- pred[pred$analysisId == idSta,]
  traits <- unique(pred$trait)
  traits.env <- aggregate(designation ~ environment + trait, data = pred, FUN = length)
  traits.env <- reshape(data=traits.env, timevar = "trait", idvar = "environment", direction="wide")
  colnames(traits.env) <- c('environment',traits)
  summarySta <- as.data.frame(traits.env[,'environment'])
  for (i in 1:length(traits)){
    temp <- traits.env[,c('environment',traits[i])]
    colnames(temp)[2] <- "temp.col"
    temp <- as.data.frame(temp)
    j=i+1
    tempp=within(temp,{
      temp.col.n=NA
      temp.col.n[!is.na(temp.col)]='âœ… '
      temp.col.n[is.na(temp.col)]=''
    })
    temp <- tempp[,3]
    summarySta <- cbind(summarySta,temp)
  }
  colnames(summarySta) <- c('environment',traits)
  
  pheno <- result$data$pheno
  ### change column names for mapping
  paramsPheno <- result$metadata$pheno
  paramsPheno <- paramsPheno[which(paramsPheno$parameter != "trait"),]
  colnames(pheno) <- cgiarBase::replaceValues(colnames(pheno), Search = paramsPheno$value, Replace = paramsPheno$parameter )
  ###
  pheno.env <- pheno[,c('environment','designation')]
  pheno.env<- unique(pheno.env[c('designation','environment')]) 
  pheno.env.designation <-  aggregate(designation ~environment, data = pheno.env, FUN = length)
  colnames(pheno.env.designation)[2] <- "Number of entries"
  summarySta <- merge(x = summarySta, y = pheno.env.designation, by = "environment", all = TRUE)
  
  if("params" %in% ls()){ # we will download the document
    printTable(summarySta)
  }else{
    summarySta <- kableExtra::kbl(summarySta)
    summarySta <-kableExtra::kable_styling(
      summarySta, 
      bootstrap_options = c("hover","condensed","responsive"), fixed_thead = T)
    kableExtra::scroll_box(summarySta,width = "100%")
  }
  
}
```

### Base metrics

The following barplot shows the value of the different parameters calculated per trial during the single trial analysis run. The view can be modified by trait and by parameter.


### Trait view

The following graphs aim to sow the genetic correlation between traits using across environment estimates of genetic merit. In addition, the radar plot displays the population means and the target values for the product profile to show the differences between these two and see how big are the gaps.


### Selection results

The following graph display the expected gain after the selection of parents and crosses for the next generation. The density plots show the base population (red), the selected population of parents (blue), and the predicted distribution of the crosses to be made (green). The distribution of selected parents and future crosses come from the optimal cross selection (OCS) run.


### Selection history

The following graph shows the realized genetic gain for this pipeline. The x-axis represents the year of origin or release of the material and the y-axis represents the trait value.


