---
title: "`r params$doc_title`"
subtitle: "`r params$doc_subtitle`"
author: "Biometrics Group, IRRI  \n  biometrics@irri.org"
date: "`r format(Sys.time(), '%B %d, %Y')`"  
# date last modified: March 9, 2023
params:
  data_rds_clp: NULL
  traits: NULL
  doc_title: "Single-Trial Analysis"
  doc_subtitle: ""
output: 
  rmdformats::robobook:
    toc_depth: 4
---

<style>
.main-container {
  max-width: 200%;
  margin-left: 0;
  margin-right: 0;
}
.tab-content {
  margin-bottom: 50px;
}
.book .book-body .page-inner {
  max-width: 2000px;
}
</style>

```{r setup, include = FALSE}

# knitr R markdown chunk options
knitr::opts_chunk$set(dependson = knitr::all_labels(),
                      include = TRUE,
                      echo = FALSE,
                      cache = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      comment = NA,
                      out.width = "100%",
                      error = TRUE)
options(knitr.kable.NA = '', knitr.duplicate.label = "allow")

# loading necessary R packages ####
## data manipulation
library(dplyr)      # %>%, data cleaning functions
library(tidyr)      # pivot_()
library(magrittr)   # %<>%, coerce col to factors or numeric
library(stringr)    # str_detect()
library(scales)     # rescale data between to values

## outputs - graphs, tables
library(ggplot2)    # ggplot(), etc.
library(DT)         # datatable()
library(knitr)      # kable()
library(kableExtra) # kable_styling(), etc.
library(viridis)    # scale_fill_viridis()
library(corrplot)   # corrplot()
library(gge)        # gge(), biplot()
library(plotly)     # ggplotly()
library(htmltools)  # tagList()

```


```{r printfxn, include = FALSE}
# functions ####
# for printing tables (data.frames) - DT::datatable()
printTable <- function(DT, pageLength = 5, 
                       numericColNames = NULL, numRound = 4, 
                       scrollXOpt = FALSE, ...) {
  
  DT <- data.frame(lapply(X = DT, 
                          FUN = function(x) {
                            if(is.numeric(x)){
                              round(x, numRound)
                            } else {
                              x
                            }
                          }))
  
  table <- DT::datatable(data = DT, 
                         filter = "top", 
                         options = list(autoWidth = TRUE, 
                                        dom = '<"pull-right"l>tpBi',# dom = '<<"pull-right"l><t>pB>i'
                                        buttons = c('copy', 'csv', 'excel'),
                                        pageLength = pageLength,
                                        searchHighlight = TRUE,
                                        lengthMenu = c(5, 10, 15, 20),
                                        scrollX = scrollXOpt),
                         extensions = 'Buttons',
                         rownames = FALSE,
                         # style = "bootstrap",
                         ...)
  if (length(numericColNames) > 0){
    table <- table %>% formatRound(columns = numericColNames,
                                   digits = numRound)
  }
  
  table
}
```

<!-- ***   -->

<!-- ## Data Preview -->

```{r data, error = FALSE}
# loading the dataset ----
# done outside the RMD

# checking
stopifnot(!is.null(params$data_rds_clp))

dt_clp <- params$data_rds_clp

dt_clean <- dt_clp

```


***


## Trial Overview

<div style = "width:100%; height:auto;">
```{r summary1}
overview_vars <- c("stage", "pipeline", "year", "season", "location", "country", "trial", "environment", "designation")
summary_list <- vector(mode = "list", length = length(overview_vars))
names(summary_list) <- overview_vars

for (i in seq_along(overview_vars)) {
  dt_clean[, overview_vars[i]] <- as.factor(dt_clean[, overview_vars[i]])
  summary_temp <- paste0(levels(dt_clean[, overview_vars[i]]), collapse = ", ")
  summary_temp <- ifelse(length(grep("^dummy_", summary_temp)) != 0, "", summary_temp)
  summary_list[[i]] <- summary_temp
}

traits <- unique(params$traits)

summaryInfo1 <- tribble(
  ~cat, ~val,
  "**Traits**", paste0(traits, collapse = ", "),
  # "**Stages**", summary_list$stage,
  # "**Pipelines**", summary_list$pipeline,
  "**Years**", summary_list$year,
  "**Seasons**", summary_list$season,
  "**Countries**", summary_list$country,
  "**Locations**", summary_list$location,
  "**Number of Trials**", as.character(length(levels(dt_clean[, "trial"]))),
  # "**Number of Environments**", as.character(length(levels(dt_clean[, "environment"]))),
  "**Number of Entries**", as.character(length(levels(dt_clean[, "designation"])))
)

names(summaryInfo1) <- c("", "")
kable(summaryInfo1) %>% kable_styling(full_width = F, position = "float_left")

```

</div>
  
```{r overview}

dt_clp_year <- unique(dt_clp$year)[1]
dt_clp_season <- unique(dt_clp$season)[1]
dt_clp_location <- unique(dt_clp$location)[1]
dt_clp_trial <- unique(dt_clp$trial)[1]

grouping_vars <- !is.na(c(dt_clp_year, dt_clp_season, dt_clp_location, dt_clp_trial))

grouping_vars_2 <- c("trial", "year", "season", "location")[grouping_vars]
grouping_vars_2_label <- str_to_title(grouping_vars_2)

# remove all "dummy"s
remove_dummy <- function(DT, col) {
  while (length(grep("*dummy_*", unique(DT[, col]))) > 0) {
    DT <- DT %>% 
      mutate({{col}} := gsub("dummy_[a-zA-Z]*_", "", DT[, col])) %>% 
      mutate({{col}} := gsub("_dummy_[a-zA-Z]*", "", DT[, col]))
  }
  return(DT)
}

dt_clean <- remove_dummy(dt_clean, "trial")


dt_clean <- dt_clean %>% mutate(trial = as.factor(trial))

trial_overview <- dt_clean %>%
  group_by(across(all_of(grouping_vars_2))) %>%
  summarize(NumEntries = n_distinct(designation))

names(trial_overview)[1:length(grouping_vars_2_label)] <- grouping_vars_2_label

printTable(trial_overview,
           caption = paste0("List of trial(s) & year(s)/season(s)/location(s) and the total number of entries"))

```

### Numerical Descriptive Measures  

```{r descStats}
descStatTemp <- list()

for (i in 1:length(traits)) {
  
  if (!traits[i] %in% names(dt_clean)) next
  
  descStatTemp[[i]] <- dt_clean %>% 
    group_by(across(all_of(grouping_vars_2))) %>% 
    summarize(trait = traits[i],
              n_non_miss = sum(!is.na(get(traits[i]))), 
              min = min(get(traits[i]), na.rm = T),
              mean = mean(get(traits[i]), na.rm = T),
              max = max(get(traits[i]), na.rm = T),
              stddev = sd(get(traits[i]), na.rm = T))
}

descStat_all <- do.call(rbind.data.frame, descStatTemp)
names(descStat_all)[1:length(grouping_vars_2_label)] <- grouping_vars_2_label

printTable(descStat_all, 
           numericColNames = c("min", "mean", "max", "stddev"))

```

&nbsp;  

```{r plot_init, include = FALSE}
# Init Step to make sure that the dependencies are loaded
# was done to enable proper printing of the tab header and the graphs within the for loop below using print(htmltools::tagList(ggplotly(...)))
htmltools::tagList(ggplotly(ggplot()))

# Get the current figure size in pixels:
get_w <- function() {
  with(knitr::opts_current$get(c("fig.width", "dpi", "fig.retina")),
       fig.width*dpi/fig.retina)
}

get_h <- function() {
  with(knitr::opts_current$get(c("fig.height", "dpi", "fig.retina")),
       fig.height*dpi/fig.retina)
}

```

```{r boxplot, results = 'asis', fig.height = 6}

# Boxplots ----
asis_output(paste0("### Boxplots {.tabset .tabset-pills}    \n\n  "))

numTraits <- length(traits)
plotly_boxplots_cleaned <- vector(mode = "list", length = numTraits)

# Visualization
for (i in 1:numTraits) {
  
  if (!traits[i] %in% names(dt_clean)) next
  
  cat("\n\n")
  cat("#### ", traits[i], "  \n ")
  
  plotly_boxplots_cleaned[[i]] <- ggplot(data = dt_clean,
                                         mapping = aes(x = factor(trial),
                                                       y = get(traits[i]),
                                                       fill = trial)) + 
    geom_boxplot() + 
    scale_fill_viridis(discrete = TRUE, alpha = 0.6) + 
    labs(title = paste0("Distribution of ", traits[i], " for each trial"),
         fill = "trial") + 
    theme_classic() + 
    theme(legend.position = "none",
          axis.text.x = element_text(angle = ifelse(
            nlevels(dt_clean[, "trial"]) > 5 || 
              max(sapply(levels(dt_clean[, "trial"]), nchar)) > 20, -20, 0))) + 
    ylab(traits[i]) + 
    xlab("trial")
  # if (nlevels(dt_clean[, "fieldinstF"]) > 5 || max(sapply(levels(dt_clean$fieldinstF), nchar)) > 20)
  #   plotly_boxplots_cleaned[[i]] <- plotly_boxplots_cleaned[[i]] + coord_flip()
  
  print(htmltools::tagList(ggplotly(plotly_boxplots_cleaned[[i]], height = get_h())))
  
  cat("\n\n&nbsp;  ")
  
}

# trait_GY <- dt_sta$modeling$trait[grep(x = dt_sta$modeling$trait, pattern = "GY|YLD|Yield|yield|YKGH")]
# has_GY <- ifelse(length(trait_GY) > 0, TRUE, FALSE)
# plot_GY_heatmap <- has_GY && (dt_clp$metadata$rowcoord != "ABSENT") && (dt_clp$metadata$colcoord != "ABSENT")

```
